const Base = require('./base.js');
const Sequelize = require('sequelize');

module.exports = class Vulnerability extends Base {
  constructor(githubClient, databaseClient) {
    super(githubClient, databaseClient);

    this.schema = {
      id: {
        type: Sequelize.BIGINT,
        primaryKey: true,
        autoIncrement: true,
      },

      summary: Sequelize.STRING(500),
      description: Sequelize.TEXT,
      dismissed: Sequelize.DATE,

      severity: Sequelize.STRING,

      file: Sequelize.STRING(500),
      package: Sequelize.STRING,
      ecosystem: Sequelize.STRING,
    };

    this.map = {
      'securityAdvisory.description': 'description',
      'securityAdvisory.summary': 'summary',
      dismissed: 'dismissed',

      'securityAdvisory.severity': 'severity',

      vulnerableManifestPath: 'file',
      'securityVulnerability.package.name': 'package',
      'securityVulnerability.package.ecosystem': 'ecosystem',
    };

    this.name = 'Vulnerability';
  }

  async sync(force) {
    this.model.belongsTo(this.dbClient.models.Repository, {
      foreignKey: 'repository_id',
    });
    await super.sync(force);
  }

  async getAll(orgName) {
    return await this.ghClient.getVulnerabilityAlerts(orgName);
  }
};
